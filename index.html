<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản đồ Khảo sát Chất lượng Sống (QoL)</title>

    <!-- Tailwind CSS để tạo giao diện hiện đại -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS - Thư viện bản đồ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Font Awesome cho biểu tượng -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Tùy chỉnh popup của Leaflet */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .custom-popup .leaflet-popup-content { margin: 15px; width: auto; }
        .custom-popup h3 { margin: 0 0 10px; font-size: 1.2rem; color: #333; }
        .custom-popup p { margin: 0; color: #666; }
        /* Kiểu cho fieldset có thể thu gọn */
        details > summary { cursor: pointer; font-weight: 600; padding: 0.5rem; background-color: #f3f4f6; border-radius: 0.25rem; transition: background-color 0.2s; }
        details > summary:hover { background-color: #e5e7eb; }
        details[open] > summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0;}
        /* Cải thiện khả năng đọc của Toast */
        #toast-notification {
            text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="overflow-hidden">
    <div class="relative h-screen w-screen font-sans">
        <!-- Bảng điều khiển bên trái -->
        <div id="panel" class="absolute top-0 left-0 z-[1000] h-full w-full transform md:w-[450px] bg-gray-100 p-4 overflow-y-auto transition-transform duration-300 md:translate-x-0">
            <div class="flex items-center mb-2">
                <i class="fas fa-chart-bar text-3xl text-blue-600 mr-3"></i>
                <h1 class="text-xl font-bold text-gray-800">Khảo sát Chất lượng Sống</h1>
                 <!-- Nút đóng cho mobile -->
                <button id="close-panel-btn" class="md:hidden ml-auto text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="survey-counter" class="text-center bg-blue-100 text-blue-800 text-sm font-semibold mb-4 px-3 py-2 rounded-lg">
                <i class="fas fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...
            </div>
            
            <!-- Form thêm điểm mới -->
            <div id="add-point-form-container" class="bg-white p-4 rounded-lg shadow-md hidden mt-4">
                <h2 class="text-lg font-semibold mb-2 text-gray-700 flex items-center"><i class="fas fa-edit mr-2 text-red-500"></i>Nhập thông tin khảo sát</h2>
                <p class="text-xs text-gray-500 mb-3">Dữ liệu được bảo mật và chỉ dùng cho mục đích nghiên cứu.</p>
                <div id="firebase-error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-3" role="alert">
                    <strong class="font-bold">Lỗi CSDL!</strong>
                    <span class="block sm:inline">Không thể kết nối. Vui lòng kiểm tra `firebaseConfig` trong code.</span>
                </div>
                <form id="location-form" class="space-y-4">
                    <input type="hidden" id="latitude">
                    <input type="hidden" id="longitude">
                    
                    <details open>
                        <summary>Phần 1: Bản thân & Môi trường</summary>
                        <div class="p-3 border border-t-0 rounded-b-md space-y-3">
                            <div>
                                <label for="age" class="block font-medium text-sm text-gray-600">Tuổi</label>
                                <input type="number" id="age" class="w-full p-2 border rounded-md mt-1" min="1" required>
                            </div>
                            <div>
                                <label for="gender" class="block font-medium text-sm text-gray-600">Giới tính</label>
                                <select id="gender" class="w-full p-2 border rounded-md mt-1"><option>Nam</option><option>Nữ</option></select>
                            </div>
                             <div>
                                <label for="family-size" class="block font-medium text-sm text-gray-600">Số người trong gia đình</label>
                                <input type="number" id="family-size" class="w-full p-2 border rounded-md mt-1" min="1">
                            </div>
                            <div>
                                <label for="marital-status" class="block font-medium text-sm text-gray-600">Tình trạng hôn nhân</label>
                                <select id="marital-status" class="w-full p-2 border rounded-md mt-1"><option>Độc thân</option><option>Đã kết hôn</option><option>Ly hôn</option><option>Góa bụa</option><option>Khác</option></select>
                            </div>
                            <div>
                                <label for="education" class="block font-medium text-sm text-gray-600">Trình độ học vấn</label>
                                <select id="education" class="w-full p-2 border rounded-md mt-1"><option>Tiểu học hoặc thấp hơn</option><option>Trung học cơ sở</option><option>Trung học phổ thông</option><option>Cao đẳng/Đại học</option><option>Sau đại học</option><option>Khác</option></select>
                            </div>
                            <div>
                                <label for="occupation" class="block font-medium text-sm text-gray-600">Nghề nghiệp hiện tại</label>
                                <select id="occupation" class="w-full p-2 border rounded-md mt-1">
                                    <option>Nông nghiệp, lâm nghiệp, ngư nghiệp</option>
                                    <option>Sản xuất, chế biến</option>
                                    <option>Xây dựng, khai thác</option>
                                    <option>Thương mại, bán lẻ</option>
                                    <option>Dịch vụ vận tải, lưu thông</option>
                                    <option>Dịch vụ cá nhân, du lịch, ăn uống</option>
                                    <option>Chuyên môn kỹ thuật, khoa học</option>
                                    <option>Chuyên môn xã hội, giáo dục, y tế</option>
                                    <option>Quản lý, hành chính</option>
                                    <option>Thất nghiệp hoặc không làm việc</option>
                                    <option>Khác</option>
                                </select>
                            </div>
                            <div>
                                <label for="income" class="block font-medium text-sm text-gray-600">Thu nhập trung bình cả gia đình/tháng</label>
                                <select id="income" class="w-full p-2 border rounded-md mt-1"><option>&lt; 5 triệu</option><option>5 - 20 triệu</option><option>20 - 50 triệu</option><option>50 - 100 triệu</option><option>&gt; 100 triệu</option></select>
                            </div>
                            <div>
                                <label for="residence-duration" class="block font-medium text-sm text-gray-600">Thời gian sống tại nơi ở hiện tại</label>
                                <select id="residence-duration" class="w-full p-2 border rounded-md mt-1"><option>&lt; 1 năm</option><option>1-5 năm</option><option>6-10 năm</option><option>&gt; 10 năm</option></select>
                            </div>
                            <div>
                                <label class="block font-medium text-sm text-gray-600">Mức độ tiếp cận dịch vụ (1=rất kém, 5=rất tốt)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1 text-center text-sm">
                                    <span>Giao thông công cộng</span><span>Chăm sóc y tế</span><span>Không gian xanh</span>
                                    <select id="access-transport" class="p-2 border rounded-md"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
                                    <select id="access-health" class="p-2 border rounded-md"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
                                    <select id="access-green" class="p-2 border rounded-md"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
                                </div>
                            </div>
                             <div>
                                <label for="noise-pollution" class="block font-medium text-sm text-gray-600 mt-2">Mức độ ảnh hưởng bởi tiếng ồn (1=Không bao giờ, 5=Thường xuyên)</label>
                                <select id="noise-pollution" class="w-full p-2 border rounded-md mt-1"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
                            </div>
                            <div>
                                <label for="air-pollution" class="block font-medium text-sm text-gray-600 mt-2">Mức độ ảnh hưởng bởi ô nhiễm không khí (1=Không bao giờ, 5=Thường xuyên)</label>
                                <select id="air-pollution" class="w-full p-2 border rounded-md mt-1"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
                            </div>
                        </div>
                    </details>
                    
                    <details>
                        <summary>Phần 2: Chất lượng cuộc sống (WHOQOL-BREF)</summary>
                        <div class="p-3 border border-t-0 rounded-b-md space-y-3 text-sm">
                            <p class="text-xs italic text-gray-500">Các câu hỏi sau đây về cảm nhận của bạn trong <strong>4 tuần</strong> trở lại đây.</p>
                            <div id="whoqol-questions-container" class="space-y-3"></div>
                        </div>
                    </details>
                    
                     <details>
                        <summary>Ghi chú thêm (tùy chọn)</summary>
                        <div class="p-3 border border-t-0 rounded-b-md">
                            <textarea id="user-notes" class="w-full p-2 border rounded-md" rows="4" placeholder="Bạn có muốn chia sẻ thêm điều gì không?"></textarea>
                        </div>
                    </details>

                    <div class="pt-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="consent-checkbox" required class="mr-2 h-4 w-4">
                            <span class="text-xs text-gray-700">Tôi đồng ý tham gia và dữ liệu được sử dụng cho nghiên cứu.</span>
                        </label>
                    </div>

                    <div class="flex space-x-2 pt-2">
                         <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i> Hoàn thành khảo sát
                        </button>
                        <button type="button" id="cancel-form-btn" class="w-full bg-gray-500 text-white py-2 rounded-md hover:bg-gray-600 transition duration-300">Hủy</button>
                    </div>
                </form>
            </div>
            
            <div id="action-buttons" class="space-y-2 mt-4">
                 <button id="locate-me-btn" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition duration-300 shadow-lg flex items-center justify-center">
                    <i class="fas fa-location-crosshairs mr-2"></i> Tự động định vị bằng GPS
                </button>
                <button id="show-form-btn" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition duration-300 shadow-lg flex items-center justify-center">
                    <i class="fas fa-plus-circle mr-2"></i> Bắt đầu khảo sát
                </button>
            </div>
            <div class="mt-6 bg-white p-4 rounded-lg shadow-md text-xs text-gray-600">
                <h3 class="font-semibold text-sm text-gray-800 mb-2">Vui lòng thực hiện các bước khảo sát sau:</h3>
                <p class="mb-2"><strong>Bước 1: Đánh dấu vị trí nơi ở của bạn trên bản đồ</strong> bằng cách:</p>
                <p class="mb-1 ml-4">1. Tự tìm và <strong>đánh dấu trên Bản đồ</strong> địa chỉ sống của mình, hoặc</p>
                <p class="mb-2 ml-4">2. Nhấn nút <strong>Tự động định vị bằng GPS</strong>, bật GPS trên thiết bị nếu bạn đang ở nhà.</p>
                <p class="mb-2">Nhấn vào nút <strong>Menu</strong> ở góc trên bên trái để ẩn/hiện bản đồ trên điện thoại.</p>
                <p class="mb-2"><strong>Bước 2: Nhấn Bắt đầu khảo sát</strong> và điền thông tin các mục. </p>
                <p class="mb-2"><strong>Bước 3: Nhấn Hoàn thành khảo sát</strong> và chờ kết quả.</p>
            </div>
             <!-- Thông tin dự án -->
            <div class="mt-6 bg-white p-4 rounded-lg shadow-md text-xs text-gray-600">          
                <h3 class="font-semibold text-sm text-gray-800 mb-2">Thông tin về dự án</h3>
                <p class="mb-2"><strong>Cám ơn bạn</strong> đã tham gia khảo sát về chất lượng sống trong bối cảnh đô thị hóa tại Việt Nam!</p>
                <p class="mb-2"><strong>Mục đích:</strong> Khảo sát này nhằm thu thập dữ liệu để nghiên cứu về Chất lượng Sống (Quality of Life - QoL) của người dân trong bối cảnh đô thị hóa tại Việt Nam. Dữ liệu từ khảo sát sẽ được kết hợp với các nguồn dữ liệu khác (dữ liệu vệ tinh, GIS, thống kê..) để hỗ trợ xây dựng các giải pháp cải thiện môi trường sống, dịch vụ đô thị và chính sách phát triển bền vững, mang lại lợi ích thiết thực cho cộng đồng. Chúng tôi sử dụng bộ câu hỏi WHOQOL-BREF (World Health Organization Quality of Life - Brief), được Tổ chức Y tế Thế giới (WHO) phát triển để đánh giá chất lượng sống một cách nhanh chóng và toàn diện. Nó được thiết kế cho các nghiên cứu và ứng dụng lâm sàng, tập trung vào nhận thức chủ quan của cá nhân về vị trí của họ trong cuộc sống, trong bối cảnh văn hóa và hệ giá trị.</p>
                <p class="mb-2"><strong>Để có dữ liệu chất lượng cao</strong>, xin bạn vui lòng điền thông tin trung thực, đúng với tình trạng cá nhân và tránh cung cấp thông tin nhạy cảm hoặc quá sai lệch. Hackers xin vui lòng không lợi dụng các lỗ hổng bảo mật.</p>
                <p class="mb-2"><strong>Cam kết:</strong> Đây là trang web mã nguồn mở. Mọi dữ liệu bạn cung cấp đều được ẩn danh, bảo mật và chỉ được sử dụng cho mục đích nghiên cứu khoa học, phi lợi nhuận. Chúng tôi cam kết tuân thủ các quy định về bảo vệ dữ liệu cá nhân. Kết quả nghiên cứu sẽ được cập nhật trên website này ngay khi chúng tôi hoàn thành nghiên cứu.</p>
                <p class="mb-2"><strong>Bắt đầu khảo sát:</strong> 13.09.2025 </p>
                <p class="mb-2"><strong>Cập nhật nội dung lần cuối:</strong> 14.09.2025 </p>
                <p class="mb-2"><strong>Liên hệ:</strong> Mọi yêu cầu, thắc mắc và mong muốn hợp tác xin vui lòng gửi về trucnhutran1999@gmail.com.</p>
                <p class="mb-2"><strong>Nhóm nghiên cứu của các du học sinh Việt Nam tại Đại học Trắc địa và bản đồ Mát-xcơ-va (LB Nga) chân thành cảm ơn và chúc bạn sức khỏe, hạnh phúc!</strong> </p>
            </div>
        </div>

        <div id="map" class="h-full w-full"></div>

         <!-- Nút mở/đóng bảng điều khiển cho mobile -->
        <button id="panel-toggle-btn" class="md:hidden absolute top-4 left-4 z-[1001] bg-white p-2 rounded-full shadow-lg text-xl w-10 h-10 flex items-center justify-center">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    
    <div id="toast-notification" class="fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-xl transition-transform transform translate-x-full duration-500 z-[2000]">
        <p id="toast-message"></p>
    </div>
    
    <!-- Modal hiển thị kết quả QoL -->
    <div id="qol-results-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[2000]">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="text-center">
                <i class="fas fa-award text-5xl text-yellow-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Kết quả Chất lượng Sống của bạn</h2>
                <p class="text-gray-600 mb-6">Cảm ơn bạn đã hoàn thành khảo sát! Dưới đây là điểm số của bạn (thang điểm 100).</p>
            </div>
            <div class="space-y-3 text-gray-700">
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                    <span class="font-semibold">1. Sức khỏe thể chất:</span>
                    <span id="score-physical" class="font-bold text-lg text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                    <span class="font-semibold">2. Tâm lý:</span>
                    <span id="score-psychological" class="font-bold text-lg text-green-600">0</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                    <span class="font-semibold">3. Quan hệ xã hội:</span>
                    <span id="score-social" class="font-bold text-lg text-purple-600">0</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                    <span class="font-semibold">4. Môi trường:</span>
                    <span id="score-environment" class="font-bold text-lg text-red-600">0</span>
                </div>
                <div class="flex justify-between items-center bg-blue-100 text-blue-800 p-4 rounded-lg mt-4">
                    <span class="font-bold text-lg">Điểm QoL tổng thể:</span>
                    <span id="score-average" class="font-extrabold text-2xl">0</span>
                </div>
            </div>
             <div class="mt-6 text-center text-sm text-gray-600 border-t pt-4">
                <p id="qol-interpretation"></p>
            </div>
            <div class="mt-8 text-center">
                <button id="close-qol-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition duration-300">Đóng</button>
            </div>
        </div>
    </div>

    <script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyCgDGcADnzYOLz_t2MwCkGC2eD5qIDCmes",
  authDomain: "qolvn-2a71a.firebaseapp.com",
  projectId: "qolvn-2a71a",
  storageBucket: "qolvn-2a71a.firebasestorage.app",
  messagingSenderId: "819016202400",
  appId: "1:819016202400:web:5b7081e5cced149d6971c5",
  measurementId: "G-KT5CV6FQ9H"
};
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let app, db, auth, userId;
        let firebaseReady = false;
        const firebaseErrorMsg = document.getElementById('firebase-error-msg');
        
        try {
            if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") throw new Error("Cấu hình Firebase không hợp lệ.");
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            firebaseReady = true;
        } catch(e) {
            console.error("Lỗi khởi tạo Firebase:", e.message);
            showToast("Lỗi kết nối CSDL.", 'error');
            if(firebaseErrorMsg) firebaseErrorMsg.classList.remove('hidden');
        }
        
        const map = L.map('map', { zoomControl: false }).setView([16.047079, 108.206230], 6);
        L.control.zoom({ position: 'topright' }).addTo(map);

        const hybridMap = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '© Google Maps' }).addTo(map);

        const panel = document.getElementById('panel');
        const panelToggleBtn = document.getElementById('panel-toggle-btn');
        const addPointFormContainer = document.getElementById('add-point-form-container');
        const actionButtons = document.getElementById('action-buttons');
        const locationForm = document.getElementById('location-form');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const surveyCounter = document.getElementById('survey-counter');
        const qolResultsModal = document.getElementById('qol-results-modal');
        const closeQolModalBtn = document.getElementById('close-qol-modal-btn');
        const locateMeBtn = document.getElementById('locate-me-btn');
        const showFormBtn = document.getElementById('show-form-btn');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const qolInterpretation = document.getElementById('qol-interpretation');
        
        let tempMarker = null;
        let selectedCoords = null;

        const whoqolQuestions = [
            { id: 'q1', text: '1. Bạn đánh giá thế nào về chất lượng cuộc sống của bạn?', options: ['Rất tồi', 'Tồi', 'Trung bình', 'Tốt', 'Rất tốt'] },
            { id: 'q2', text: '2. Bạn có hài lòng với sức khỏe của bạn không?', options: ['Rất không hài lòng', 'Không hài lòng', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q3', text: '3. Thương tật thể xác cản trở bạn thế nào?', options: ['Không', 'Ít', 'Trung bình', 'Nhiều', 'Rất nhiều'], reverse: true },
            { id: 'q4', text: '4. Bạn cần chăm sóc y tế ở mức độ nào?', options: ['Không', 'Ít', 'Trung bình', 'Nhiều', 'Rất nhiều'], reverse: true },
            { id: 'q5', text: '5. Bạn hài lòng với cuộc sống hiện tại thế nào?', options: ['Không', 'Ít', 'Trung bình', 'Nhiều', 'Rất nhiều'] },
            { id: 'q6', text: '6. Bạn có cảm thấy cuộc sống của bạn có ý nghĩa không?', options: ['Không', 'Ít', 'Trung bình', 'Nhiều', 'Rất nhiều'] },
            { id: 'q7', text: '7. Khả năng tập trung của bạn thế nào?', options: ['Không', 'Ít', 'Trung bình', 'Cao', 'Rất cao'] },
            { id: 'q8', text: '8. Mức độ bạn cảm thấy an toàn trong cuộc sống là thế nào?', options: ['Không', 'Ít', 'Trung bình', 'Cao', 'Rất cao'] },
            { id: 'q9', text: '9. Môi trường sống của bạn lành mạnh thế nào?', options: ['Không', 'Ít', 'Trung bình', 'Cao', 'Rất cao'] },
            { id: 'q10', text: '10. Bạn có cảm thấy đủ sức lực cho hoạt động thường ngày không?', options: ['Không', 'Ít', 'Trung bình', 'Tương đối', 'Hoàn toàn'] },
            { id: 'q11', text: '11. Bạn có chấp nhận được ngoại hình của bạn không?', options: ['Không', 'Ít', 'Trung bình', 'Tương đối', 'Hoàn toàn'] },
            { id: 'q12', text: '12. Bạn có đủ tiền cho nhu cầu cá nhân không?', options: ['Không', 'Ít', 'Trung bình', 'Tương đối', 'Hoàn toàn'] },
            { id: 'q13', text: '13. Thông tin bạn cần có được cập nhật hàng ngày không?', options: ['Không', 'Ít', 'Trung bình', 'Tương đối', 'Hoàn toàn'] },
            { id: 'q14', text: '14. Bạn có vui chơi giải trí không?', options: ['Không', 'Ít', 'Trung bình', 'Nhiều', 'Rất nhiều'] },
            { id: 'q15', text: '15. Bạn có đi lại được tốt không?', options: ['Rất tồi', 'Tồi', 'Trung bình', 'Tốt', 'Rất tốt'] },
            { id: 'q16', text: '16. Bạn hài lòng với giấc ngủ của mình thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q17', text: '17. Bạn hài lòng với khả năng sinh hoạt hàng ngày thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q18', text: '18. Bạn hài lòng về khả năng làm việc của bạn thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q19', text: '19. Bạn hài lòng với chính bản thân bạn thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q20', text: '20. Bạn hài lòng về mối quan hệ cá nhân thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q21', text: '21. Bạn hài lòng về đời sống tình dục thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q22', text: '22. Bạn hài lòng về sự giúp đỡ từ bạn bè thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q23', text: '23. Bạn hài lòng về điều kiện vật chất nơi ở thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q24', text: '24. Bạn hài lòng về việc tiếp cận dịch vụ y tế thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q25', text: '25. Bạn hài lòng về phương tiện đi lại của bạn thế nào?', options: ['Rất tệ', 'Tệ', 'Trung bình', 'Hài lòng', 'Rất hài lòng'] },
            { id: 'q26', text: '26. Bạn có thường xuyên có cảm giác tiêu cực không?', options: ['Không bao giờ', 'Hiếm khi', 'Thi thoảng', 'Rất thường xuyên', 'Liên tục'], reverse: true },
        ];

        function generateWhoqolForm() {
            const container = document.getElementById('whoqol-questions-container');
            container.innerHTML = whoqolQuestions.map(q => `
                <div>
                    <label for="${q.id}" class="block font-medium text-gray-600">${q.text}</label>
                    <select id="${q.id}" class="w-full p-2 border rounded-md mt-1" data-reverse="${q.reverse || false}" required>
                        ${q.options.map((opt, i) => `<option value="${i+1}">${opt}</option>`).join('')}
                    </select>
                </div>
            `).join('');
        }
        generateWhoqolForm();

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-xl transition-transform transform duration-500 z-[2000]`;
            
            if (type === 'error') {
                toast.classList.add('bg-white', 'text-red-700', 'border', 'border-red-300');
            } else if (type === 'info') {
                toast.classList.add('bg-white', 'text-blue-700', 'border', 'border-blue-300');
            } else {
                toast.classList.add('bg-white', 'text-green-700', 'border', 'border-green-300');
            }
            
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 5000);
        }

        function calculateWhoqolScores(whoqolData) {
            const domains = {
                physical: ['q3', 'q4', 'q10', 'q15', 'q16', 'q17', 'q18'],
                psychological: ['q5', 'q6', 'q7', 'q11', 'q19', 'q26'],
                social: ['q20', 'q21', 'q22'],
                environment: ['q8', 'q9', 'q12', 'q13', 'q14', 'q23', 'q24', 'q25']
            };
            const getScore = (key) => {
                const q = whoqolQuestions.find(q => q.id === key);
                const val = parseInt(whoqolData[key], 10);
                return q.reverse ? (6 - val) : val;
            };
            const calculateDomainScore = (name) => {
                const keys = domains[name];
                const rawScore = keys.reduce((sum, key) => sum + getScore(key), 0);
                return ((rawScore - keys.length) / (keys.length * 4)) * 100;
            };
            const scores = {
                physical: calculateDomainScore('physical'),
                psychological: calculateDomainScore('psychological'),
                social: calculateDomainScore('social'),
                environment: calculateDomainScore('environment'),
            };
            scores.average = (scores.physical + scores.psychological + scores.social + scores.environment) / 4;
            return scores;
        }

        function showResultsModal(scores) {
            document.getElementById('score-physical').textContent = scores.physical.toFixed(1);
            document.getElementById('score-psychological').textContent = scores.psychological.toFixed(1);
            document.getElementById('score-social').textContent = scores.social.toFixed(1);
            document.getElementById('score-environment').textContent = scores.environment.toFixed(1);
            document.getElementById('score-average').textContent = scores.average.toFixed(1);
            
            const avg = scores.average;
            let interpretationText = "Điểm số này cho thấy chất lượng sống của bạn ở mức kém. Có nhiều vấn đề nghiêm trọng cần được giải quyết. Hãy liên hệ với chúng tôi hoặc các tổ chức uy tín để được hỗ trợ.";
            if (avg >= 85) {
                interpretationText = "Mức điểm này cho thấy chất lượng sống của bạn đang ở mức rất tốt. Bạn có sự hài lòng cao với hầu hết các khía cạnh trong cuộc sống.";
            } else if (avg >= 70) {
                 interpretationText = "Mức điểm này cho thấy chất lượng sống của bạn đang ở mức tốt. Hầu hết các khía cạnh đều ổn, tuy nhiên vẫn còn một vài lĩnh vực có thể cải thiện.";
            } else if (avg < 50) {
                 interpretationText = "Mức điểm này cho thấy chất lượng sống của bạn đang ở mức trung bình. Có thể bạn đang đối mặt với nhiều khó khăn trong các khía cạnh khác nhau của cuộc sống.";
            }
            qolInterpretation.textContent = interpretationText;

            qolResultsModal.classList.remove('hidden');
        }
        closeQolModalBtn.addEventListener('click', () => qolResultsModal.classList.add('hidden'));

        if (firebaseReady) {
            const locationsCollection = collection(db, 'locations');
            let locationMarkers = L.layerGroup().addTo(map);

            onAuthStateChanged(auth, async (user) => {
                if (user) { userId = user.uid; loadSavedLocations(); } 
                else { await signInAnonymously(auth); }
            });

            function loadSavedLocations() {
                onSnapshot(locationsCollection, (snapshot) => {
                    locationMarkers.clearLayers();
                    surveyCounter.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Tổng số lượt đã khảo sát: <span class="font-bold text-lg">${snapshot.size}</span>`;
                    const sortedDocs = snapshot.docs.sort((a, b) => (a.data().createdAt?.seconds || 0) - (b.data().createdAt?.seconds || 0));

                    sortedDocs.forEach((doc, index) => {
                        const data = doc.data();
                        if (data.coords?.lat && data.coords?.lng && data.surveyData?.qolScores) {
                            const marker = L.marker([data.coords.lat, data.coords.lng]);
                            const qolScore = data.surveyData.qolScores.average;
                            const popupContent = `<div class="custom-popup text-center"><h3 class="font-bold">Khảo sát #${index + 1}</h3><p class="text-gray-600">Điểm Chất lượng Sống (QoL):</p><p class="text-3xl font-extrabold text-blue-600 my-2">${qolScore.toFixed(1)} / 100</p></div>`;
                            marker.bindPopup(popupContent);
                            locationMarkers.addLayer(marker);
                        }
                    });
                }, (error) => {
                    console.error("Lỗi khi tải dữ liệu từ Firestore: ", error);
                    showToast("Không thể tải dữ liệu điểm.", 'error');
                    surveyCounter.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Lỗi tải dữ liệu`;
                });
            }
            
            locationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const lat = parseFloat(latitudeInput.value);
                const lng = parseFloat(longitudeInput.value);

                if (!lat || !lng) return showToast("Vui lòng đánh dấu vị trí nơi ở của bạn trước khi lưu.", 'error');
                if (!userId) return showToast("Chưa xác thực người dùng. Vui lòng đợi.", 'error');
                
                const surveyData = {
                    age: document.getElementById('age').value,
                    gender: document.getElementById('gender').value,
                    familySize: document.getElementById('family-size').value,
                    maritalStatus: document.getElementById('marital-status').value,
                    education: document.getElementById('education').value,
                    occupation: document.getElementById('occupation').value,
                    income: document.getElementById('income').value,
                    residenceDuration: document.getElementById('residence-duration').value,
                    accessTransport: document.getElementById('access-transport').value,
                    accessHealth: document.getElementById('access-health').value,
                    accessGreen: document.getElementById('access-green').value,
                    noisePollution: document.getElementById('noise-pollution').value,
                    airPollution: document.getElementById('air-pollution').value,
                    userNotes: document.getElementById('user-notes').value,
                    whoqol: whoqolQuestions.reduce((acc, q) => {
                        acc[q.id] = document.getElementById(q.id).value;
                        return acc;
                    }, {})
                };
                
                surveyData.qolScores = calculateWhoqolScores(surveyData.whoqol);

                try {
                    await addDoc(locationsCollection, { surveyData, coords: { lat, lng }, createdAt: serverTimestamp(), userId });
                    showToast("Đã lưu khảo sát thành công!", 'success');
                    showResultsModal(surveyData.qolScores);
                    resetForm();
                } catch (error) {
                    console.error("Lỗi khi lưu vào Firestore: ", error);
                    showToast("Lưu khảo sát thất bại.", 'error');
                }
            });
        } else {
             surveyCounter.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Lỗi kết nối CSDL`;
             locationForm.querySelector('button[type="submit"]').disabled = true;
        }

        document.querySelectorAll('input[name="base-layer"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                map.removeLayer(currentBaseLayer);
                let newLayer;
                switch(e.target.value) {
                    case 'satellite': newLayer = satelliteMap; break;
                    case 'hybrid': newLayer = hybridMap; break;
                    default: newLayer = streetMap;
                }
                newLayer.addTo(map);
                currentBaseLayer = newLayer;
            });
        });
        
        panelToggleBtn.addEventListener('click', () => {
            panel.classList.toggle('-translate-x-full');
        });

        function setSurveyMode(enable) {
            if(enable){
                addPointFormContainer.classList.remove('hidden');
                actionButtons.classList.add('hidden');
            } else {
                addPointFormContainer.classList.add('hidden');
                actionButtons.classList.remove('hidden');
            }
        }
        
        showFormBtn.addEventListener('click', () => {
            if (!selectedCoords) {
                showToast('Vui lòng đánh dấu vị trí nơi ở của bạn trên bản đồ trước khi bắt đầu khảo sát.', 'info');
                return;
            }
            map.getContainer().style.cursor = 'crosshair';
            setSurveyMode(true);
             if(window.innerWidth < 451) panel.classList.remove('-translate-x-full');
        });

        cancelFormBtn.addEventListener('click', () => resetForm());

        function resetForm() {
            locationForm.reset();
            latitudeInput.value = '';
            longitudeInput.value = '';
            selectedCoords = null;
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = null;
            map.getContainer().style.cursor = '';
            setSurveyMode(false);
        }

        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            setMarkerAndPosition(lat, lng);
        });

        function setMarkerAndPosition(lat, lng) {
            latitudeInput.value = lat;
            longitudeInput.value = lng;
            selectedCoords = {lat, lng};
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);
            if (addPointFormContainer.classList.contains('hidden')) {
                 tempMarker.bindPopup("Vị trí đã chọn. Hãy bắt đầu khảo sát.").openPopup();
            } else {
                 tempMarker.bindPopup("Vị trí đã chọn. Hãy điền khảo sát bên trái.").openPopup();
            }
        }
        
        locateMeBtn.addEventListener('click', () => {
            if (!navigator.geolocation) return showToast('Trình duyệt không hỗ trợ định vị.', 'error');
            showToast('Đang tìm vị trí của bạn...', 'info');
             if(window.innerWidth < 451) panel.classList.add('-translate-x-full');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 15);
                    setSurveyMode(true);
                    setMarkerAndPosition(latitude, longitude);
                },
                (error) => showToast('Không thể lấy vị trí.', 'error')
            );
        });

        // Mở panel mặc định trên điện thoại khi tải trang
        if (window.innerWidth < 451) {
            panel.classList.remove('-translate-x-full');
        }
    </script>
</body>
</html>

